
<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ Ø³Ø§Ù…Ø§Ù†Ù‡ Ø­Ø¶ÙˆØ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Vazir', sans-serif;
      background: linear-gradient(to right, #f0f4ff, #e3ecf9);
      color: #333;
      padding: 20px;
      direction: rtl;
    }
    h2, h3 {
      color: #003366;
    }
    input, select, button, textarea {
      margin: 6px 0;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    button {
      background-color: #004d99;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0066cc;
    }
    .student-box {
      background-color: #ffffff;
      border: 1px solid #99c2ff;
      margin-top: 10px;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #aaccee;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #d0e4ff;
    }
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/js/persian-datepicker.min.js"></script>


<meta name="theme-color" content="#004d99">
<link rel="manifest" href="data:application/manifest+json," onload="
  const manifest = document.getElementById('inline-manifest');
  if (manifest) {
    const blob = new Blob([manifest.textContent], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    this.href = url;
  }
">

<script id="inline-manifest" type="application/json">
{
  "name": "Ø³Ø§Ù…Ø§Ù†Ù‡ Ø­Ø¶ÙˆØ± Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†",
  "short_name": "Ø­Ø¶ÙˆØ±",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#004d99",
  "lang": "fa",
  "icons": [
    {
      "src": "https://cdn-icons-png.flaticon.com/512/2942/2942187.png",
      "sizes": "192x192",
      "type": "image/png"
    }
  ]
}
</script>

<script>
  if ('serviceWorker' in navigator) {
    const blob = new Blob([`
      self.addEventListener('install', event => {
        event.waitUntil(
          caches.open('attendance-cache-v1').then(cache => {
            return cache.addAll([location.href]);
          })
        );
      });
      self.addEventListener('fetch', event => {
        event.respondWith(
          caches.match(event.request).then(resp => {
            return resp || fetch(event.request);
          })
        );
      });
    `], { type: 'application/javascript' });

    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl)
      .then(() => console.log('âœ… Service Worker registered inline'))
      .catch(error => console.error('âŒ Service Worker error:', error));
  }
</script>

</head>
<body>
  <h2 style="margin-bottom: 5px;">ğŸ“ Ø³Ø§Ù…Ø§Ù†Ù‡ Ø­Ø¶ÙˆØ±</h2>

  <button onclick="startVoiceCommand()" style="margin-top:10px; font-size:14px;">ğŸ™ï¸ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ÙØ±Ù…Ø§Ù† ØµÙˆØªÛŒ</button>
<h3>ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§Ø³</h3>
  <select id="classSelector"></select>
  <input type="text" id="newClassName" placeholder="Ù†Ø§Ù… Ú©Ù„Ø§Ø³ Ø¬Ø¯ÛŒØ¯">
  <button id="createClassBtn">Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§Ø³</button>
  <button id="deleteClassBtn">ğŸ—‘ï¸ Ø­Ø°Ù Ú©Ù„Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</button>

  <hr>
  <h3>ğŸ‘¥ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´Ø¬Ùˆ</h3>
  <div style="display:flex; gap:6px;"><input type="text" id="studentName" placeholder="Ù†Ø§Ù… Ø¯Ø§Ù†Ø´Ø¬Ùˆ" style="flex:1;">
<button onclick="startVoiceInput('studentName')" style="font-size:14px;">ğŸ¤</button></div>
  <button id="addStudentBtn">Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´Ø¬Ùˆ</button>

  <h3>ğŸ“‹ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ø§Ø³Ø§Ù…ÛŒ (Ø¨Ù‡â€ŒØµÙˆØ±Øª ÛŒÚ©Ø¬Ø§)</h3>
  <textarea id="bulkList" placeholder="Ù‡Ø± Ø§Ø³Ù… Ø±Ø§ Ø¯Ø± ÛŒÚ© Ø®Ø· Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." rows="6"></textarea>
  <button id="bulkImportBtn">ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª</button>

  
  <h3>â• Ø§ÙØ²ÙˆØ¯Ù† ÙØ¹Ø§Ù„ÛŒØª Ú©Ù„Ø§Ø³ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
  <div style="display:flex; gap:6px; flex-wrap:wrap;">
    <input type="text" id="activityTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙØ¹Ø§Ù„ÛŒØª (Ù…Ø«Ù„Ø§Ù‹: Ø§Ø±Ø§Ø¦Ù‡ ÙˆÛŒÚ˜Ù‡)" style="flex:2;">
    <input type="number" id="activityScore" placeholder="Ù†Ù…Ø±Ù‡" min="0" max="20" step="0.5" style="width:100px;">
    <button onclick="addCustomActivity()" style="font-size:14px;">âœ… Ø§ÙØ²ÙˆØ¯Ù†</button>
  </div>


<h3>ğŸ“… ØªÙ‚ÙˆÛŒÙ… Ø¬Ù„Ø³Ø§Øª Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</h3>
<div id="calendarSessions" style="margin-bottom: 30px;">
  <input type="text" id="calendarInput" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®" style="width:200px;">
  <div id="calendarSummary" style="margin-top: 10px; font-size: 14px;"></div>
</div>

<h3>ğŸ•˜ Ø´Ø±ÙˆØ¹ Ø¬Ù„Ø³Ù‡ Ø¬Ø¯ÛŒØ¯</h3>
  <input type="text" id="sessionCategory" placeholder="Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ù„Ø³Ù‡ (Ù…Ø«Ù„Ø§Ù‹: ÙØµÙ„ Ø§ÙˆÙ„)">
  <button id="startSessionBtn">Ø«Ø¨Øª Ø¬Ù„Ø³Ù‡ Ø¬Ø¯ÛŒØ¯</button>

  
  <h3>ğŸ“ Ù†Ú©Ø§Øª Ø¬Ù„Ø³Ù‡</h3>
  <textarea id="sessionNotes" placeholder="Ø·Ø±Ø­ Ø¯Ø±Ø³ØŒ Ù…ÛŒØ²Ø§Ù† ØªØ¯Ø±ÛŒØ³ØŒ Ù†Ú©Ø§Øª Ù…Ù‡Ù…..." rows="4" style="width:100%;"></textarea>

<div id="sessionArea" style="display:none">
    <h3>âœï¸ Ø«Ø¨Øª ÙˆØ¶Ø¹ÛŒØª Ø¯Ø§Ù†Ø´Ø¬ÙˆØ§Ù†</h3>
    <div id="studentsList"></div>
    <button id="saveSessionBtn">Ø°Ø®ÛŒØ±Ù‡ Ø¬Ù„Ø³Ù‡</button>
  </div>

  <h3>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø¬Ù„Ø³Ø§Øª</h3>
  <button id="showReportBtn">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</button>
  <div id="report"></div>

  
<h3>ğŸ”” Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯</h3>
<button onclick="showAlerts()" style="font-size:14px;">ğŸ“£ Ù†Ù…Ø§ÛŒØ´ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</button>
<div id="alertsArea" style="margin-top:10px; font-size:14px; color:darkred;"></div>

<h3>ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´ Ø®Ù„Ø§ØµÙ‡ Ú©Ù„ÛŒ</h3>
<button id="exportExcelBtn">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Excel</button>
  <button id="showSummaryBtn">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ø®Ù„Ø§ØµÙ‡</button>
  <div id="summaryReport"></div>

  <h3>ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</h3>
  <button id="downloadBackupBtn">ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
  <input type="file" id="backupFile" accept=".json">

  <script>
    let allData = JSON.parse(localStorage.getItem('multiClassData') || '{}');
    let currentClass = '';
    let students = [];
    let sessions = [];

    function loadClassList() {
      const selector = document.getElementById('classSelector');
      selector.innerHTML = '';
      for (const className in allData) {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        selector.appendChild(option);
      }
    }

    function saveCurrentClassData() {
      if (currentClass) {
        allData[currentClass] = { students, sessions };
        localStorage.setItem('multiClassData', JSON.stringify(allData));
      }
    }

    function loadClassData() {
      currentClass = document.getElementById('classSelector').value;
      if (currentClass && allData[currentClass]) {
        students = allData[currentClass].students || [];
        sessions = allData[currentClass].sessions || [];
        document.getElementById('sessionArea').style.display = 'none';
        refreshStudentList();
        document.getElementById('report').innerHTML = '';
        document.getElementById('summaryReport').innerHTML = '';
      }
    }

    function createClass() {
      const name = document.getElementById('newClassName').value.trim();
      if (!name) return alert('Ù†Ø§Ù… Ú©Ù„Ø§Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      if (allData[name]) return alert('Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯.');
      allData[name] = { students: [], sessions: [] };
      localStorage.setItem('multiClassData', JSON.stringify(allData));
      loadClassList();
      document.getElementById('classSelector').value = name;
      loadClassData();
      alert('Ú©Ù„Ø§Ø³ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯.');
    }

    function addStudent() {
      const name = document.getElementById('studentName').value.trim();
      if (name && !students.includes(name)) {
        students.push(name);
        saveCurrentClassData();
        alert('Ø¯Ø§Ù†Ø´Ø¬Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
        refreshStudentList();
        document.getElementById('studentName').value = '';
      }
    }

    function importStudentList() {
      const text = document.getElementById('bulkList').value.trim();
      if (!text) return;
      const names = text.split(/\r?\n/).map(n => n.trim()).filter(n => n);
      let added = 0;
      names.forEach(name => {
        if (!students.includes(name)) {
          students.push(name);
          added++;
        }
      });
      document.getElementById('bulkList').value = '';
      saveCurrentClassData();
      alert(`${added} Ø¯Ø§Ù†Ø´Ø¬Ùˆ ÙˆØ§Ø±Ø¯ Ø´Ø¯`);
    }

    function startSession() {
      const cat = document.getElementById('sessionCategory').value.trim();
      if (!cat) return alert('Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ù„Ø³Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      if (students.length === 0) return alert('Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´Ø¬ÙˆØ§Ù† Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');
      const container = document.getElementById('studentsList');
      container.innerHTML = '';
      students.forEach(name => {
        const div = document.createElement('div');
        div.className = 'student-box';
        div.innerHTML = `
          <strong>${name}</strong><br>
          ÙˆØ¶Ø¹ÛŒØª:
          <select id="status-${name}">
            <option value="Ø­Ø§Ø¶Ø±">Ø­Ø§Ø¶Ø±</option>
            <option value="ØºØ§ÛŒØ¨">ØºØ§ÛŒØ¨</option>
            <option value="ØªØ§Ø®ÛŒØ±">ØªØ§Ø®ÛŒØ±</option>
          </select><br>
          ÙØ¹Ø§Ù„ÛŒØª Ú©Ù„Ø§Ø³ÛŒ:
          ${generateActivitySelect(name)}
            <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
            <option value="Ú©Ù†ÙØ±Ø§Ù†Ø³ Û³ Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ">Ú©Ù†ÙØ±Ø§Ù†Ø³ Û³ Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ</option>
            <option value="Ú©Ù†ÙØ±Ø§Ù†Ø³ Û² Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ">Ú©Ù†ÙØ±Ø§Ù†Ø³ Û² Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ</option>
            <option value="Ú©Ù†ÙØ±Ø§Ù†Ø³ Û± Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ">Ú©Ù†ÙØ±Ø§Ù†Ø³ Û± Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ</option>
            <option value="Ø®Ù„Ø§ØµÙ‡ Ø¯Ø±Ø³">Ø®Ù„Ø§ØµÙ‡ Ø¯Ø±Ø³ (Û°.Ûµ)</option>
            <option value="Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª">Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª (Û°.Ûµ)</option>
            <option value="Ù…Ø¹Ø±ÙÛŒ Ù…Ø­ØªÙˆØ§">Ù…Ø¹Ø±ÙÛŒ Ù…Ø­ØªÙˆØ§ (Û°.Ûµ)</option>
          </select>
        `;
        container.appendChild(div);
      });
      document.getElementById('sessionArea').style.display = 'block';
    }

    
    function saveSession() {
      const cat = document.getElementById('sessionCategory').value.trim();
      const note = document.getElementById('sessionNotes').value.trim();
      const record = {};
      students.forEach(name => {
        const status = document.getElementById(`status-${name}`).value;
        const activity = document.getElementById(`activity-${name}`).value;
        record[name] = { status, activity };
      });
      sessions.push({
        date: new Date().toLocaleDateString('fa-IR'),
        category: cat,
        record,
        note
      });
      saveCurrentClassData();
      alert('Ø¬Ù„Ø³Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
      document.getElementById('sessionArea').style.display = 'none';
      document.getElementById('sessionNotes').value = '';
    }
);

function showSessionByDate(date) {
  const div = document.getElementById("calendarSummary");
  div.innerHTML = '';
  let found = false;
  sessions.forEach(s => {
    if (s.date === date) {
      found = true;
      const counts = { Ø­Ø§Ø¶Ø±: 0, ØºØ§ÛŒØ¨: 0, ØªØ§Ø®ÛŒØ±: 0 };
      for (const name in s.record) {
        const status = s.record[name].status;
        if (counts[status] !== undefined) counts[status]++;
      }
      div.innerHTML += `<strong>Ø¬Ù„Ø³Ù‡ ${s.category} (${s.date})</strong><br>
      Ø­Ø§Ø¶Ø±: ${counts.Ø­Ø§Ø¶Ø±} | ØºØ§ÛŒØ¨: ${counts.ØºØ§ÛŒØ¨} | ØªØ§Ø®ÛŒØ±: ${counts.ØªØ§Ø®ÛŒØ±}`;
    }
  });
  if (!found) div.innerHTML = "Ø¬Ù„Ø³Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø§ÛŒÙ† ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.";
}


    
function showAlerts() {
  const thresholdAbsences = 3;
  const thresholdLowActivity = 1.5;
  const summary = {}, activityScores = {
    "Ú©Ù†ÙØ±Ø§Ù†Ø³ Û³ Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ": 3, "Ú©Ù†ÙØ±Ø§Ù†Ø³ Û² Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ": 2, "Ú©Ù†ÙØ±Ø§Ù†Ø³ Û± Ù†Ù…Ø±Ù‡â€ŒØ§ÛŒ": 1,
    "Ø®Ù„Ø§ØµÙ‡ Ø¯Ø±Ø³ (Û°.Ûµ)": 0.5, "Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª (Û°.Ûµ)": 0.5, "Ù…Ø¹Ø±ÙÛŒ Ù…Ø­ØªÙˆØ§ (Û°.Ûµ)": 0.5
  };
  customActivities.forEach(item => {
    const match = item.match(/\((\d+(\.\d+)?)\)/);
    if (match) activityScores[item] = parseFloat(match[1]);
  });

  students.forEach(name => {
    summary[name] = { ØºØ§ÛŒØ¨: 0, score: 0 };
  });

  sessions.forEach(s => {
    for (const name in s.record) {
      const st = s.record[name].status;
      const act = s.record[name].activity;
      if (st === 'ØºØ§ÛŒØ¨') summary[name].ØºØ§ÛŒØ¨++;
      if (activityScores[act]) summary[name].score += activityScores[act];
    }
  });

  const alerts = [];
  for (const name in summary) {
    const g = summary[name].ØºØ§ÛŒØ¨;
    const s = summary[name].score;
    if (g >= thresholdAbsences) {
      alerts.push(`ğŸš¨ ${name} Ø¨ÛŒØ´ Ø§Ø² ${thresholdAbsences} Ø¬Ù„Ø³Ù‡ ØºÛŒØ¨Øª Ø¯Ø§Ø´ØªÙ‡ Ø§Ø³Øª.`);
    }
    if (s < thresholdLowActivity) {
      alerts.push(`âš ï¸ ${name} Ù…Ø¬Ù…ÙˆØ¹ ÙØ¹Ø§Ù„ÛŒØª Ú©Ù…ØªØ± Ø§Ø² ${thresholdLowActivity} Ø¯Ø§Ø±Ø¯.`);
    }
  }

  document.getElementById("alertsArea").innerHTML = alerts.length
    ? alerts.join("<br>")
    : "Ù‡ÛŒÚ† Ù‡Ø´Ø¯Ø§Ø± ÙØ¹Ø§Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.";
}


    // Initialize after DOM ready
    window.onload = () => {
      loadClassList();
      document.getElementById('classSelector').onchange = loadClassData;
      document.getElementById('createClassBtn').onclick = createClass;
      document.getElementById('addStudentBtn').onclick = addStudent;
      document.getElementById('bulkImportBtn').onclick = importStudentList;
      document.getElementById('startSessionBtn').onclick = startSession;
      document.getElementById('saveSessionBtn').onclick = saveSession;
      document.getElementById('showReportBtn').onclick = showReport;
      document.getElementById('showSummaryBtn').onclick = showSummary;
      document.getElementById('downloadBackupBtn').onclick = downloadBackup;
      document.getElementById('backupFile').onchange = restoreBackup;
      document.getElementById('deleteClassBtn').onclick = deleteClass;
document.getElementById('exportExcelBtn').onclick = exportExcel;
    };
  

function exportExcel() {
  if (!currentClass || !sessions.length) {
    alert('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
    return;
  }

  let csv = 'Ú©Ù„Ø§Ø³,ØªØ§Ø±ÛŒØ®,Ù†Ø§Ù…,ÙˆØ¶Ø¹ÛŒØª,ÙØ¹Ø§Ù„ÛŒØª,ÛŒØ§Ø¯Ø¯Ø§Ø´Øª,Ø±Ù†Ú¯
';
  sessions.forEach(session => {
    for (const name in session.record) {
      const entry = session.record[name];
      const note = studentNotes[name] || '';
      const color = studentTags[name] || '';
      csv += `${currentClass},${session.date},${name},${entry.status},${entry.activity},${note},${color}
`;
    }
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentClass}_report.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

</script>

</body>
</html>
